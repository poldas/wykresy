define(function(t,e,n){"use strict";var i=t("riot-observable");var r=/^.+?\/+[^\/]+/,f="EventListener",o="remove"+f,s="add"+f,u="hasAttribute",c="replace",a="popstate",h="trigger",l=3,p=window,d=document,v=p.history.location||p.location,m=q.prototype,b=d&&d.ontouchstart?"touchstart":"click",g=false,w=i(),y,$,x,A,K=[],N=0;function E(t){return t.split(/[\/?#]/)}function k(t,e){var n=new RegExp("^"+e[c](/\*/g,"([^/?#]+?)")[c](/\.\./,".*")+"$"),i=t.match(n);if(i)return i.slice(1)}function q(){this.$=[];i(this);w.on("stop",this.s.bind(this));w.on("emit",this.e.bind(this))}function D(t){return t[c](/^\/|\/$/,"")}function L(t){return typeof t=="string"}function O(t){return(t||v.href)[c](r,"")}function P(t){return y[0]=="#"?(t||v.href).split(y)[1]||"":O(t)[c](y,"")}function R(t){var e=N==0;if(l<=N)return;N++;K.push(function(){var e=P();if(t||e!=$){w[h]("emit",e);$=e}});if(e){while(K.length){K[0]();K.shift()}N=0}}function S(t){if(t.which!=1||t.metaKey||t.ctrlKey||t.shiftKey||t.defaultPrevented)return;var e=t.target;while(e&&e.nodeName!="A")e=e.parentNode;if(!e||e.nodeName!="A"||e[u]("download")||!e[u]("href")||e.target&&e.target!="_self"||e.href.indexOf(v.href.match(r)[0])==-1)return;if(e.href!=v.href){if(e.href.split("#")[0]==v.href.split("#")[0])return;_(P(e.href),e.title||d.title)}t.preventDefault()}function _(t,e){e=e||d.title;history.pushState(null,e,y+D(t));d.title=e;R()}m.m=function(t,e){if(L(t)&&(!e||L(e)))_(t,e);else if(e)this.r(t,e);else this.r("@",t)};m.s=function(){this.off("*");this.$=[]};m.e=function(t){this.$.concat("@").some(function(e){var n=(e=="@"?x:A)(D(t),D(e));if(n){this[h].apply(null,[e].concat(n));return true}},this)};m.r=function(t,e){if(t!="@"){t="/"+D(t);this.$.push(t)}this.on(t,e)};var j=new q;var z=j.m.bind(j);z.create=function(){var t=new q;t.m.stop=t.s.bind(t);return t.m.bind(t)};z.base=function(t){y=t||"#";$=P()};z.exec=function(){R(true)};z.parser=function(t,e){if(!t&&!e){x=E;A=k}if(t)x=t;if(e)A=e};z.query=function(){var t={};v.href[c](/[?&](.+?)=([^&]*)/g,function(e,n,i){t[n]=i});return t};z.stop=function(){if(g){p[o](a,R);d[o](b,S);w[h]("stop");g=false}};z.start=function(t){if(!g){p[s](a,R);d[s](b,S);g=true}if(t)R(true)};z.base();z.parser();n.exports=z});